<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>TFM Azure IOT Application - Getting started guide -
STM32CubeIDE</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="_htmresc/mini-st_2020.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1
id="tfm-azure-iot-application---getting-started-guide---stm32cubeide"><mark>TFM
Azure IOT Application - Getting started guide - STM32CubeIDE</mark></h1>
<p><br/> <br/></p>
<h1 id="setting-up-your-development-environment">Setting Up your
Development Environment</h1>
<h2 id="step-1-setup-your-development-board">Step 1: Setup your
development board</h2>
<p><img src="./_htmresc/Common/setup_development_board.png" /></p>
<ol type="1">
<li>Verify that the 5V_USB_STL and JP3 jumpers are bridged and the
remaining jumpers are not bridged.</li>
<li>Check that the BOOT0 switch is in the position closest to the STLINK
USB connector.</li>
<li>Connect a USB micro-B cable between the USB_STLK connector and your
computer.</li>
</ol>
<p>The USB STLK port is located to the right of the MXCHIP WiFi module
in the figure. It is used for power supply, programming, debugging, and
interacting with the application via UART over USB.</p>
<h2 id="step-2-install-prerequisites-packages">Step 2: Install
Prerequisites Packages</h2>
<h3 id="windows"><strong>Windows</strong></h3>
<p>The project build system needs a unix or posix-like shell. There are
many options for installing such a shell on windows.<br />
This guide assume you are using GitBash which is included in the Git for
Windows package.<br />
Any other compatible shell will work, except the one provided by the
windows subsystem for windows (wsl).</p>
<h4
id="download-and-install-the-latest-version-of-the-following-packages"><strong>*
Download and install the latest version of the following
packages:</strong></h4>
<ul>
<li><a href="https://www.python.org/downloads/">python</a> (with
pip)<br />
</li>
<li><a href="https://gitforwindows.org/">git for windows</a></li>
<li><a href="http://www.teraterm.org/">Tera Term</a></li>
</ul>
<h4 id="add-bash.exe-to-your-path"><strong>* Add bash.exe to your
Path:</strong></h4>
<p>In order to use the project scripts and the related STM32CubeIDE
launch files, you must include bash.exe in your system path.</p>
<ol type="1">
<li><p>Locate your preferred version of bash.exe and determine the
windows path to it.</p>
<p>For reference, the default location for GitBash is
<code>C:\Program Files\Git\bin</code>.</p></li>
<li><p>Run the following command to open the environment variable editor
from Control Panel:</p></li>
</ol>
<pre><code>rundll32 sysdm.cpl,EditEnvironmentVariables</code></pre>
<ol start="3" type="1">
<li><p>Select the “Path” user environment variable and click
“Edit”.</p></li>
<li><p>Select “New” and then paste the path to the directory containing
bash.exe found above.</p></li>
<li><p>Press OK and OK to exit the environment variable editor.</p></li>
<li><p>Log out of your windows session and then log back in to allow the
environment variable changes to take effect.</p></li>
</ol>
<h3 id="linux"><strong>Linux</strong></h3>
<p>Install dependencies using your distribution’s package manager and
add the required additional python modules:</p>
<h4 id="debian-based-.deb-apt">Debian based (.deb / apt)</h4>
<pre><code>sudo apt install python3 python-is-python3
pip install numpy intelhex jinja2</code></pre>
<h4 id="redhat-.rpm-dnf-yum">Redhat (.rpm / dnf / yum)</h4>
<pre><code>sudo dnf install -y python3 python-is-python3
sudo dnf groupinstall -y &quot;Development Tools&quot; &quot;Development Libraries&quot; --skip-broken
pip install numpy intelhex jinja2</code></pre>
<h2 id="step-3-install-stm32cubeide">Step 3: Install STM32CubeIDE</h2>
<p>Download the latest version of STM32CubeIDE from the <a
href="https://www.st.com/en/development-tools/stm32cubeide.html">STMicroelectronics
website</a>.</p>
<p>At the time of this writing, Version 1.12.0 was the latest release: -
<a
href="https://www.st.com/en/development-tools/stm32cubeide.html">STM32CubeIDE</a></p>
<p>Abridged installation instructions are included below. Please refer
to the <a
href="https://www.st.com/resource/en/user_manual/um2563-stm32cubeide-installation-guide-stmicroelectronics.pdf">STM32CubeIDE
Installation guide</a> and the included instructions for your platform
if additional help is needed.</p>
<p>The projects in this repository have been verified with versions
1.12.0 of STM32CubeIDE.</p>
<h3 id="windows-normal-install">Windows Normal Install</h3>
<ol type="1">
<li>Download the [STM32CubeIDE windows zip
archive][https://www.st.com/en/development-tools/stm32cubeide.html].</li>
<li>Unzip the package by double-clicking.</li>
<li>Run the extracted installer executable.</li>
</ol>
<h3 id="ubuntu-linux-debian-linux-etc-deb-package">Ubuntu Linux, Debian
Linux, etc (deb package)</h3>
<p>Open a terminal window and follow the steps below to install
STM32CubeIDE on a Debian based Linux machine.</p>
<p>Download the STM32CubeIDE Linux generic installer package</p>
<pre><code>wget &lt;URL HERE&gt;</code></pre>
<p>Extract the package</p>
<pre><code>unzip en.st-stm32cubeide_*_amd64.deb_bundle.sh.zip</code></pre>
<p>Add execute permissions to the install package</p>
<pre><code>chmod +x st-stm32cubeide_*_amd64.deb_bundle.sh</code></pre>
<p>Extract the debian packages from the bundle:</p>
<pre><code>mkdir -p cubeide_install
./st-stm32cubeide_1.9.0_12015_20220302_0855_amd64.deb_bundle.sh --tar xvf --directory cubeide_install .</code></pre>
<p>Install the debian packages</p>
<pre><code>export LICENSE_ALREADY_ACCEPTED=1
sudo apt install -y ./cubeide_install/st-stm32cubeide-1.9.0-12015-20220302-0855_amd64.deb ./cubeide_install/st-stlink-udev-rules-1.0.3-2-linux-all.deb ./cubeide_install/st-stlink-server-2.1.0-1-linux-amd64.deb</code></pre>
<p>Start the IDE</p>
<pre><code>/opt/st/stm32cubeide_1.9.0/stm32cubeide_wayland
# Or
/opt/st/stm32cubeide_1.9.0/stm32cubeide</code></pre>
<h3 id="redhat-derivatives-rpm-package">Redhat derivatives (rpm
package)</h3>
<p>Open a terminal window and follow the steps below to install
STM32CubeIDE on a Redhat based linux machine.</p>
<p>Download the [STM32CubeIDE linux rpm installer
package][ide_url_rpm]</p>
<pre><code>wget &lt;URL HERE&gt;</code></pre>
<p>Extract the package</p>
<pre><code>unzip en.st-stm32cubeide_*amd64.rpm_bundle.sh.zip</code></pre>
<p>Add execute permissions to the install package</p>
<pre><code>chmod +x st-stm32cubeide_*amd64.rpm_bundle.sh</code></pre>
<p>Start the installation script and follow the prompts on the command
line.</p>
<pre><code>sudo ./st-stm32cubeide_1.9.0_12015_20220302_0855_amd64.rpm_bundle.sh</code></pre>
<h3 id="linux---generic-installer">Linux - Generic Installer</h3>
<p>Open a terminal window and follow the steps below to install
STM32CubeIDE on a generic linux machine.</p>
<p>Download the STM32CubeIDE [linux generic installer
package][ide_url_lin]:</p>
<pre><code>wget &lt;URL&gt;</code></pre>
<p>Extract the package</p>
<pre><code>unzip en.st-stm32cubeide*amd64.sh.zip</code></pre>
<p>Add execute permissions to the install package</p>
<pre><code>chmod +x st-stm32cubeide_*amd64.sh</code></pre>
<p>Start the installation script and follow the prompts on the command
line.</p>
<pre><code>./st-stm32cubeide_1.9.0_12015_20220302_0855_amd64.sh</code></pre>
<h2 id="step-4-import-projects-into-stm32cubeide">Step 4: Import
Projects into STM32CubeIDE</h2>
<ol type="1">
<li>Open STM32CubeIDE.</li>
<li>When asked to open a workspace directory, select the default one or
choose your preferred development location.</li>
</ol>
<blockquote>
<p>Note: If you are not asked to select a workspace when STM32CubeIDE
start, you may access this dialog via the <strong><em>File -&gt; Switch
Workspace -&gt; Other</em></strong> menu item.</p>
</blockquote>
<ol start="3" type="1">
<li>Select <strong><em>File -&gt; Import</em></strong>.<br />
</li>
<li>Select <strong><em>General -&gt; Existing Projects Into
Workspace</em></strong> in the <strong><em>Select an Import
Wizard</em></strong> dialog and click <strong>Next &gt;</strong>.<br />
</li>
<li>Click <strong>Browse</strong> next to the <em>Select root
directory</em> box and navigate to the root of the TFM_Azure_Iot
directory.<br />
</li>
<li>Click the check box next to all projects and then click
<strong>Finish</strong>.</li>
</ol>
<blockquote>
<p>Note:<br />
* Ensure that <em>Search nested projects</em> <strong>is
selected</strong><br />
* Ensure that <em>copy projects into workspace</em> <strong>is not
selected</strong></p>
</blockquote>
<figure>
<img src="./_htmresc/Getting_Started_STM32CubeIDE/Import_projects.png"
alt="Import_projects" />
<figcaption aria-hidden="true">Import_projects</figcaption>
</figure>
<h2
id="step-5-build-firmware-image-and-flash-your-development-board">Step
5: Build Firmware image and Flash your development board</h2>
<p>After importing the workspace into STM32CubeIDE, you will end up with
several projects organized in 3 top level groups.</p>
<figure>
<img src="./_htmresc/Getting_Started_STM32CubeIDE/Workspace.png"
alt="Workspace" />
<figcaption aria-hidden="true">Workspace</figcaption>
</figure>
<p><strong>TFM_Appli</strong><br />
* <strong>TFM_Appli_NonSecure</strong> : Actual Azure IoT
application<br />
* <strong>TFM_Appli_Secure</strong> : Secure API for the NonSecure
application<br />
* <strong>TFM_Appli_Secure_G</strong> : Special project to generate
Secure API source files based on selected TFM partitions.</p>
<p><strong>TFM_Loader</strong><br />
* <strong>TFM_Loader_NonSecure</strong> : A special application to
upload new TFM_Appli (secure and non-secure) via the serial port
(Y-Modem).<br />
* <strong>TFM_Loader_Secure</strong> : Secure part of the Loader
application.</p>
<p><strong>TFM_SBSFU_Boot</strong> : Secure Bootloader based on the TFM
implementation.</p>
<p></br></p>
<h3 id="building">Building</h3>
<p>In the <strong>Project Explorer</strong> pane of STM32CubeIDE, select
the non-secure project by clicking it’s name
<strong>TFM_Appli_NonSecure</strong><br />
Then click on the arrow next to the hammer icon to select the
configuration you want to build (Wifi, Cellular BG96 or Cellular
Type1SC)<br />
<img
src="./_htmresc/Getting_Started_STM32CubeIDE/Build_Configuration.png"
alt="Build_configuration" /></p>
<p>Next, click on hammer icon to build the project.<br />
The project are linked together, so building TFM_Appli_NonSecure will
trigger the build process of all related projects (ie, TFM_Appli_Secure,
TFM_Appli_Secure_G, TFM_Loader_NonSecure, TFM_Loader_Secure,
TFM_SBSFU_Boot)</p>
<blockquote>
<p>Note: You may also build the current project using the
<strong>Project</strong>-&gt;<strong>Build Project</strong> menu
item.</p>
</blockquote>
<h2 id="step-6-provision-and-flash-your-board">Step 6: Provision and
Flash Your Board</h2>
<h3 id="connect-your-board-via-usb.">6.1 - Connect your board via
USB.</h3>
<p><img src="./_htmresc/BU585I-USB-connected.jpg" /></p>
<h3 id="using-the-quickconnect-scripts.">6.2 - Using the QuickConnect
scripts.</h3>
<p>Automated script to configure your Azure environment, provision your
board and flash the firmware are provided in the AzureScripts
directory.</p>
<p>Please refer to one of the following documentation :</p>
<ol type="1">
<li><a
href="./AzureScripts/readme/README_IOT_Hub_Auto.html">QC_IOT_HUB</a> :
Connect the board to Azure Iot Hub with QuickConnect script</li>
<li><a
href="./AzureScripts/readme/README_IOT_Hub_Manual.html">MANUAL_IOT_HUB</a>
: Connect the board to Azure Iot Hub Manually</li>
<li><a
href="./AzureScripts/readme/README_IOT_Central_Auto.html">QC_IOT_CENTRAL</a>
: Connect the board the board to Azure Iot Central with QuickConnect
script</li>
<li><a
href="./AzureScripts/readme/README_IOT_Central_Manual.html">MANUAL_IOT_CENTRAL</a>
: Connect the board to Azure Iot Central Manually</li>
</ol>
<h3 id="using-the-provided-external-tools-shortcut.">6.3 - Using the
provided external tools shortcut.</h3>
<p>The external tools shortcuts can only flash and manage your board’s
firmware.<br />
If you need to configure your Azure environment and provision your
board, please proceed with the QuickConnect documentation referenced
above.</p>
<figure>
<img src="./_htmresc/Getting_Started_STM32CubeIDE/External_tools.png"
alt="External_tools" />
<figcaption aria-hidden="true">External_tools</figcaption>
</figure>
<p>Several tools are pre-configured:<br />
1. Disable TZ: if you want to revert your board to non-tfm
configuration.<br />
2. Generate Data img: This script will generate the initial data images
(secure and non-secure).<br />
This script needs to be run once before flashing your board.<br />
3. Regression: This script will prepare you board for TFM
application.<br />
It will enable the Trust-Zone and set various parameters.<br />
This script needs to be run only once before anything else.<br />
4. Reset board: restart the MCU by issuing a hard-reset command.<br />
5. TFM Update (Appli_NonSecure): flash only the non-secure
application.<br />
Used if you’ve only rebuild the non-secure application.<br />
6. TFM Update (Appli_Secure): flash only the secure application.<br />
Used if you’ve only rebuild the secure application.<br />
7. TFM Update (all): flash all application parts (Appli, loader, data
and bootloader)</p>
<p>Before anything else, you must prepare your board with the
<strong>regression’s script</strong> (this needs to be done only
once)<br />
Then you should flash all the application parts with the
<strong>TFM_UPDATE script</strong>.</p>
<h3 id="connecting-to-the-board">6.4 - Connecting to the board</h3>
<p>The application output can be monitored thru the serial port.</p>
<ol type="1">
<li>Open and configure Tera-Term under <strong>Setup -&gt; Serial
Port…</strong><br />
<img src="./_htmresc/TeraTermSetup.png" /><br />
</li>
<li>Select the correct port for your board and configure Tera-Term as
follow:<br />
<img src="./_htmresc/TeraTermSetupSerial.png" /><br />
</li>
<li>Navigate to <strong>Setup -&gt; Terminal</strong><br />
<img src="./_htmresc/TeraTermSetupTerminalNavigate.png" /><br />
</li>
<li>Check the ‘Local echo’ box, select ‘CR’ for Transmit, and select
‘OK’<br />
<img src="./_htmresc/TeraTermSetupTerminal.png" /><br />
</li>
<li>Reset the board with the black ‘RST’ button and view the output in
Tera-Term</li>
</ol>
<h2 id="step-7-debugging">Step 7: Debugging</h2>
<p>The project workspace provides a pre-configured debug
environment.<br />
&gt; The board should have be flash with the build firmware prior to
starting the debug session.</p>
<p>Click the black arrow next to the bug icon and select
<strong>TFM_Appli_NonSecure Debug</strong></p>
<p><img
src="./_htmresc/Getting_started_STM32CubeIDE/Debugging.png" /></p>
<p>STM32CubeIde will then connect to the running process on the board
and start the debugging session.</p>
<p><img
src="./_htmresc/Getting_started_STM32CubeIDE/DebugSession.png" /></p>
</body>
</html>
